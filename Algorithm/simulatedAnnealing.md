# 模拟退火
&emsp; 首先，我们要知道，模拟退火是一种求解多峰函数全局最优解的算法。和爬山算法一样，模拟退火本质上也是一种贪心的算法，只是它在爬山的基础上增加了一个随机因子。使得他有一定的概率能够跳到比自己更不优的状态上去来增加跳到全局最优的概率。

## 金属退火
### 定义
&emsp; 顾名思义，模拟退火算法就是一种模拟金属退火的算法。所以我们先来看看金属退火是个什么东西：

>退火是一种金属热处理工艺，指的是将金属缓慢加热到一定温度，保持足够时间，然后以适宜速度冷却。目的是降低硬度，改善切削加工性；降低残余应力，稳定尺寸，减少变形与裂纹倾向；细化晶粒，调整组织，消除组织缺陷。准确的说，退火是一种对材料的热处理工艺，包括金属材料、非金属材料。而且新材料的退火目的也与传统金属退火存在异同。
>将固体加温至充分高，再让其徐徐冷却，加温时，固体内部粒子随温升变为无序状，内能增大，而徐徐冷却时粒子渐趋有序，在每个温度都达到平衡态，最后在常温时达到基态，内能减为最小。

&emsp; 注意最后一句话 "内能减为最小"，这就是我们要模拟的东西了，我们把要的解看成内能，然后模拟一遍金属的退火过程就能得到 "内能" 的最小值。

### 物理过程
&emsp; 根据蒙特卡洛准则，我们知道当材料的内能要从 $E_i$，转化成 $E_j$ 时，分两种情况：

1. 如果 $E_j < E_i$，那么 100% 的 $E_i$ 会转变成 $E_j$。
2. 如果 $E_j \geq E_i$，那么 $E_i$ 就会有 $p(\Delta E) = e^{\frac{\Delta E}{kT}}$ 的概率转成 $E_j$。这里的 $\Delta E = E_i - E_j$，$k$ 是玻尔兹曼常数，$T$ 是当前的温度。

&emsp; 而在热平衡状态下，材料在状态 $i$ 的概率是满足玻尔兹曼分布的，也就是：
$$ P(X = i) = \frac{e^{\frac{-E_i}{kT}}}{\sum\limits_{j\in S} e^{\frac{-E_j}{kT}}} $$

&emsp; 这里的 $S$ 是一个集合，表示状态空间，$X$ 是材料当前状态的随机变量。这里我们假设 $T$ 很大（就取个极限嘛），每一个状态的概率就是：
$$ P(X = i) = \lim_{T\to \infty} \frac{e^{\frac{-E_i}{kT}}}{\sum\limits_{j\in S} e^{\frac{-E_j}{kT}}} = \frac{1}{\sum\limits_{j\in S}1} = \frac{1}{\mid S \mid} $$

&emsp; 这里的 $\mid S \mid$ 表示状态空间 $S$ 的大小。这个结论也就表明在温度很大的时候所有状态的出现的可能性几乎就是一样的。也就是说在一开始模拟退火的时候，我们的当前状态会在整个函数上到处乱跑。

&emsp; 然后温度慢慢地也会降下来，我们来看看温度很低的时候（再取个极限 qwq）这个概率分布会变成什么样子：
$$ P(X = i) = \lim_{T\to 0} \frac{e^{\frac{E_{min}-E_i}{kT}}}{\sum\limits_{j\in S} e^{\frac{E_{min}-E_j}{kT}}} = \lim_{T\to 0}\frac{e^{\frac{E_{min}-E_i}{kT}}}{\sum\limits_{j\in S_{min}} e^{\frac{E_{min}-E_j}{kT}} + \sum\limits_{j \notin S_{min}}e^{\frac{E_{min}-E_j}{kT}}} $$

&emsp; 这里的 $S_{min}$ 表示内能取到最低的时候的集合，然后当 $T$ 趋近于 0，那么 $\frac{-E_j}{kT}$ 就趋近于正无穷，那么：
$$ \lim_{T\to 0}\sum_{j \notin S_{min}}e^{\frac{E_{min}-E_j}{kT}} = 0 $$

&emsp; 为什么只有这一项可以消为 0 呢？因为这一项中的 $E_{min}-E_j$ 绝对不为 0。所以：
$$ P(X = i) = \lim_{T\to 0} \frac{e^{\frac{E_{min}-E_i}{kT}}}{\sum\limits_{j\in S_{min}} e^{\frac{E_{min}-E_j}{kT}} + 0} = \lim_{T\to 0} \frac{e^{\frac{E_{min}-E_i}{kT}}}{\sum\limits_{j\in S_{min}} e^{\frac{E_{min}-E_j}{kT}}} $$

&emsp; 我们发现，当 $i \notin S_{min}$ 的时候上面的那一项也可以消为 0，就是这样：
$$ \lim_{T\to0} e^{\frac{E_{min}-e_i}{kT}} = 0 $$

&emsp; 所以这个时候我们就有：
$$ P(X = i) = \lim_{T\to 0} \frac{e^{\frac{E_{min}-E_i}{kT}}}{\sum\limits_{j\in S_{min}} e^{\frac{E_{min}-E_j}{kT}}} = \lim_{T\to 0} \frac{0}{\sum\limits_{j\in S_{min}} e^{\frac{E_{min}-E_j}{kT}}} = 0 $$

&emsp; 所以只有在 $i \in S_{min}$ 的时候 $P(X = i)$ 才可能有不为 0 的值，也就是：
$$ P(X = i) = \lim_{T\to 0} \frac{e^{\frac{E_{min}-E_i}{kT}}}{\sum\limits_{j\in S_{min}} e^{\frac{E_{min}-E_j}{kT}}} = \frac{1}{\mid S_{min} \mid} $$

&emsp; 所以说当温度低的时候，内能大概率会进到最低的状态。在模拟退火中就是当 $T$ 很小的时候我们就有很大可能找到全局最优解。

## 回到正题--模拟退火
&emsp; 原理其实前面就已经讲得很清楚了 qwq，所以我们直接来看算法流程和怎么实现算法。
### 算法流程
&emsp; 算法流程其实就是模拟金属的退火，首先一层循环模拟温度，然后通过随机扰动产生新的解，并通过上述的蒙特卡洛准则来决定是否接受新解。当然，温度开始的时候应该要很高，这样就几乎所有的新解都能被接受，然后缓慢的降低温度，并得到最优解。具体流程如下：

1. 令初始温度 $T = T_0$，然后随机产生一个初始解 $x_0$，并带进原函数中计算 $E_{x_0}$ 
2. 令 $T = kT$，其中 $k \in (0, 1)$ 表示温度的下降速率。
3. 对当前的 $x_T$ 产生一个随机扰动，在它的附近得到一个新解 $x_T'$，然后根据蒙特卡洛法则决定是否接受新解。蒙特卡洛准则如下：
$$p(\Delta E) = \begin{cases} 1 \;\qquad \Delta E < 0 \\ e^{\frac{\Delta E}{kT}} \quad \Delta E \geq 0 \end{cases}$$
其中 $\Delta E = E_{x_T'} - E_{x_T}$。
4. 在每一个温度 $T$ 下，执行 $L$ 次扰动并重复执行步骤 3。
5. 判断温度是否足够低，能否终止，如果不能终止，就返回步骤 2。

### 实现
&emsp; 关于模拟退火还有一个很神奇的事情，那就是调参。在上面我们介绍算法流程的时候我们使用了多个常数，它们分别为：

1. $k$ ：温度下降的速率
2.  $L$ ：每个 $T$ 中的扰动次数
3. $T_0$：初始温度
4. 另一个 $k$：玻尔兹曼常数

&emsp; 这里面除了玻尔兹曼常数是定值之外，其他的常数都不知道是多少，这就需要算法设计者自己慢慢调节这些参数，使得得到正确的解的概率最大化。而且在调参的过程中，某一个常数一点点的改动就可能导致很大的误差，所以调参是一个非常烦人但是必不可少的工作。

&emsp; 除了调参来增加准确率之外，如果时间充足，我们还可以多跑几遍模拟退火得到几个解最后总和几次的解来得到答案。